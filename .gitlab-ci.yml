stages:
  - build_and_push

variables:
  IMAGE_TAG_COMMIT: "$DOCKER_HUB_REPO:$CI_COMMIT_SHORT_SHA"
  IMAGE_TAG_BRANCH: "$DOCKER_HUB_REPO:$CI_COMMIT_REF_SLUG"

services:
  - docker:dind

build_and_push_docker_image:
  stage: build_and_push
  image: docker:latest
  
  before_script:
    - echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
    - echo "Docker Login erfolgreich."
  
  script:
    - echo "Berechneter IMAGE_TAG_COMMIT '$IMAGE_TAG_COMMIT'"
    - echo "Berechneter IMAGE_TAG_BRANCH '$IMAGE_TAG_BRANCH'"

    ## DOCKER BUILD #
    - cd src/
    - docker build -t "$IMAGE_TAG_COMMIT" . 
    # DOCKER IMAGES ##
    - echo "Docker Build erfolgreich. Lokale Images vor dem Tagging:"
    - docker images
    - echo "-------------------------------------------"
    - docker tag "$IMAGE_TAG_COMMIT" "$IMAGE_TAG_BRANCH"
    - echo "Docker Tagging erfolgreich. Lokale Images nach dem Tagging:"
    - docker images
    # DOCKER PUSH ##
    - docker push "$IMAGE_TAG_COMMIT"
    - docker push "$IMAGE_TAG_BRANCH"
    # Optional: Den 'latest'-Tag nur f√ºr den 'main'-Branch pushen
    - if [ "$CI_COMMIT_BRANCH" == "main" ]; then docker tag "$IMAGE_TAG_COMMIT" "$DOCKER_HUB_REPO:latest"; docker push "$DOCKER_HUB_REPO:latest"; else echo "Branch ist nicht 'main', 'latest' wird nicht gepusht"; fi
    - echo "Alle Push-Operationen abgeschlossen"
  
  rules:
    - if: '$CI_COMMIT_BRANCH'